(self.webpackChunkapp_studio_enterprise_schema_view=self.webpackChunkapp_studio_enterprise_schema_view||[]).push([[3267],{93267:(le,ae,c)=>{c.r(ae),c.d(ae,{AdditionalParamsChangeHandler:()=>U,AdfsAdditionalParamsChangeHandler:()=>G,AdfsSaveValidationHandler:()=>L,AdfsTenantValidator:()=>O,AdfsUrlChangeHandler:()=>D,IdpNameChangeHandler:()=>$,IdpSaveValidationHandler:()=>F,IsJsonValidator:()=>K,LoadSamlMetadataHandler:()=>M,LoadSamlMetadataRequest:()=>Q,LoadSpDataHandler:()=>N,OpenSamlDataGridRowHandler:()=>f,SamlDataGridRowDoubleClickHandler:()=>P,SamlIdpCertificateService:()=>_,SamlProviderSaveValidationHandler:()=>q,SaveSamlIdpCertificatesHandler:()=>J,SaveSpDataHandler:()=>b,SaveSpDataRequest:()=>z,SpDataChangeHandler:()=>T,SsoProviderSaveValidationHandler:()=>Z,SsoProviderService:()=>y,SsoServiceProvider:()=>de,SsoServiceProviderEntityConverter:()=>A,SsoServiceProviderService:()=>v,SsoSettingsModule:()=>C,SsoSettingsV2DataChangeHandler:()=>w,StringUrlValidator:()=>W,TestSsoHandler:()=>B,TestSsoRequest:()=>X,UploadSamlIdpCertificateHandler:()=>k,UploadSamlIdpCertificateRequest:()=>Y,UploadSamlIdpMetadataHandler:()=>j,UploadSamlIdpMetadataRequest:()=>ee});var l=c(8239),s=c(74742),g=c(2876),i=c(75378),se=c(20606),x=c(27049);let Q=class extends i.BaseRequest{};Q=(0,s.__decorate)([(0,i.CrtRequest)({type:"crt.LoadSamlMetadataRequest"})],Q);let M=class extends i.BaseRequestHandler{constructor(e){super(),this.httpClient=e,this._samlMetadataUrl="/rest/SsoActionsService/GetSamlMetadata"}handle(e){var t=this;return(0,l.Z)(function*(){return t.httpClient.get(t._samlMetadataUrl,{responseType:"text"}).pipe((0,x.map)(a=>{const r="creatio_saml_metadata.xml",n=new Blob([a],{type:"application/xml"});se.saveAs(n,r,{autoBom:!1})})).subscribe(),t.next?.handle(e)})()}};M=(0,s.__decorate)([(0,i.CrtRequestHandler)({type:"crt.LoadSamlMetadataHandler",requestType:"crt.LoadSamlMetadataRequest",scopes:["CustomIdpSettingsForm","SsoSamlBase_FormPage"]}),(0,s.__metadata)("design:paramtypes",[g.HttpClient])],M);let D=class extends i.BaseRequestHandler{_tryUpdateSamlEndpoints(e){var t=this;return(0,l.Z)(function*(){if(e.attributeName!=="AdfsUrl")return;const a=yield e.$context.AdfsUrl;e.oldValue!==a&&t._setSamlEndpoints(e,a)})()}_tryUpdateAdfsUrl(e){return(0,l.Z)(function*(){if(e.attributeName!=="PartnerIdentityName")return;const t=yield e.$context.AdfsUrl,a=yield e.$context.PartnerIdentityName;!t&&a&&(e.$context.AdfsUrl=new URL(a).host)})()}_setSamlEndpoints(e,t){e.$context.PartnerIdentityName=`http://${t}/adfs/services/trust`;const a=`https://${t}/adfs/ls`;e.$context.SingleLogoutServiceUrl=a,e.$context.SingleSignOnServiceUrl=a}handle(e){var t=this;return(0,l.Z)(function*(){return yield t._tryUpdateSamlEndpoints(e),yield t._tryUpdateAdfsUrl(e),t.next?.handle(e)})()}};D=(0,s.__decorate)([(0,i.CrtRequestHandler)({type:"crt.AdfsUrlChangeHandler",requestType:"crt.HandleViewModelAttributeChangeRequest",scopes:["AdfsSettingsForm","SsoSamlAdfs_FormPage"]})],D);var u=c(49475),R=c(77207),E=c(6523),I=c(97600),p=c(94450);class A{getEntity(e){const t=e;return{id:t.Id,ssoIdentityProvider:(0,I.isEmpty)(t.SsoIdentityProvider)?null:t.SsoIdentityProvider,useJit:t.UseJit,useSlo:t.UseSlo,name:t.Name,assertionConsumerServiceUrl:t.AssertionConsumerServiceUrl,singleLogoutServiceUrl:t.SingleLogoutServiceUrl}}getEntityColumns(e){return[new u.EntityColumn("Id",e.id,i.DataValueType.Guid),new u.EntityColumn("SsoIdentityProvider",e.ssoIdentityProvider,i.DataValueType.Lookup),new u.EntityColumn("UseJit",e.useJit,i.DataValueType.Boolean),new u.EntityColumn("UseSlo",e.useSlo,i.DataValueType.Boolean),new u.EntityColumn("Name",e.name,i.DataValueType.Text),new u.EntityColumn("AssertionConsumerServiceUrl",e.assertionConsumerServiceUrl,i.DataValueType.Text),new u.EntityColumn("SingleLogoutServiceUrl",e.singleLogoutServiceUrl,i.DataValueType.Text)]}}A.\u0275fac=function(e){return new(e||A)},A.\u0275prov=p.\u0275\u0275defineInjectable({token:A,factory:A.\u0275fac,providedIn:"any"});class v extends E.BaseEntityService{constructor(e,t,a){super(e,t,a),this.entitySchemaName="SsoServiceProvider"}}v.\u0275fac=function(e){return new(e||v)(p.\u0275\u0275inject(E.QueryExecutor),p.\u0275\u0275inject(R.TranslateService),p.\u0275\u0275inject(A))},v.\u0275prov=p.\u0275\u0275defineInjectable({token:v,factory:v.\u0275fac,providedIn:"any"});class y{constructor(e){this.queryExecutor=e}isUniqueIdpName(e,t,a,r){const n=new i.EntitySchemaQuery(a);return n.addAggregationFunctionColumn("Id",i.AggregationType.Count,"Count"),n.filters.addSchemaColumnFilterWithParameter(i.ComparisonType.Equal,r,e),n.filters.addSchemaColumnFilterWithParameter(i.ComparisonType.Not_equal,"Id",t),this.queryExecutor.executeSelectQuery(n).pipe((0,x.map)(d=>{if(d&&d.length){const[S]=d;return S.Count===0}return!0}))}}y.\u0275fac=function(e){return new(e||y)(p.\u0275\u0275inject(E.QueryExecutor))},y.\u0275prov=p.\u0275\u0275defineInjectable({token:y,factory:y.\u0275fac,providedIn:"any"});var H=c(87646);class _{_getCertificateBase64(e){let t="";const a=e.length();for(let r=0;r<a;r++)t+=String.fromCharCode(e.at(r));return t}_parceCertificate(e){let t=this._getCertificateBase64(e),a;if(/\s*-----BEGIN/.test(t)){a=H.pki.certificateFromPem(t);const d=H.pki.pemToDer(t);t=this._getCertificateBase64(d)}else{const d=H.asn1.fromDer(e,{strict:!1,parseAllBytes:!1});a=H.pki.certificateFromAsn1(d)}const r=H.md.sha1.create();r.update(t);const n=r.digest().toHex().toUpperCase();return{certificate:a,thumbprint:n}}_fillCeritficateModel(e,t,a){return(0,l.Z)(function*(){e.reload([]);const r=yield e.createItem();r.IdpCertificatesDataGridDS_Id=(0,i.generateGuid)(),r.IdpCertificatesDataGridDS_NotAfter=t.certificate.validity.notAfter,r.IdpCertificatesDataGridDS_NotBefore=t.certificate.validity.notBefore,r.IdpCertificatesDataGridDS_Name=t.certificate.subject.attributes.map(n=>`${n.shortName}=${n.value}`).join(","),r.IdpCertificatesDataGridDS_Thumbprint=t.thumbprint,r.fileDto=a})()}addCertificateToCollection(e,t){var a=this;return(0,l.Z)(function*(){const r=new H.util.ByteStringBuffer(t.content),n=a._parceCertificate(r);return yield a._fillCeritficateModel(e,n,t),n.thumbprint})()}}_.\u0275fac=function(e){return new(e||_)},_.\u0275prov=p.\u0275\u0275defineInjectable({token:_,factory:_.\u0275fac,providedIn:"any"});let N=class extends i.BaseRequestHandler{constructor(e,t){super(),this.ssoServiceProviderService=e,this._maskService=t}_setServiceProviderColumns(e,t){e.setValue({SpIdAttribute:t.id},{silent:!0}),e.setValue({SpIdentityProviderAttribute:t.ssoIdentityProvider},{silent:!0}),e.setValue({SpUseJitAttribute:t.useJit},{silent:!0}),e.setValue({SpUseSloAttribute:t.useSlo},{silent:!0})}handle(e){var t=this;return(0,l.Z)(function*(){const a=e.$context,r="SP_DATA_LOADING";return yield t._maskService.showMask(r,a),t.ssoServiceProviderService.getItems().subscribe(n=>{if(t._maskService.hideMask(r,a),n.success&&n.result.length){const[d]=n.result;t._setServiceProviderColumns(a,d)}return t.next?.handle(e)})})()}};N=(0,s.__decorate)([(0,i.CrtRequestHandler)({type:"crt.LoadSpDataHandler",requestType:"crt.HandleViewModelInitRequest",scopes:["SsoSettings","SsoSettingsV2"]}),(0,s.__param)(1,(0,i.CrtInject)(u.DEVKIT_MASK_SERVICE)),(0,s.__metadata)("design:paramtypes",[v,i.MaskService])],N);var V=c(99293),h=c(21322);let z=class extends i.BaseRequest{};z=(0,s.__decorate)([(0,i.CrtRequest)({type:"crt.SaveSpDataRequest"})],z);let b=class extends i.BaseRequestHandler{constructor(e,t,a){super(),this.ssoServiceProviderService=e,this._dialogService=t,this._maskService=a,this._ssoLoginEndpoint="/ServiceModel/AuthService.svc/SsoLogin",this._ssoLogoutEndpoint="/ServiceModel/AuthService.svc/SsoLogout"}_getSiteOriginUrl(){return(0,u.getWorkspaceBaseUrl)().replace("/0/","").replace(new RegExp("/$"),"")}_onSavedSpData(e,t){var a=this;return(0,l.Z)(function*(){return yield a._maskService.hideMask("SAVE_SP_DATA",t.$context),e?.success?(t.$context.IsSpChanged=!1,t.$context.formApiModel.markAsPristine()):e?.success===!1&&e?.errorInfo&&a._dialogService.openInfoDialog(e?.errorInfo.message),a.next?.handle(t)})()}handle(e){var t=this;return(0,l.Z)(function*(){const a=e.$context,r=t._getSiteOriginUrl(),n=yield a.SpIdentityProviderAttribute,d={id:yield a.SpIdAttribute,ssoIdentityProvider:n||null,useJit:yield a.SpUseJitAttribute,useSlo:yield a.SpUseSloAttribute,name:r,assertionConsumerServiceUrl:r+t._ssoLoginEndpoint,singleLogoutServiceUrl:r+t._ssoLogoutEndpoint};return yield t._maskService.showMask("SAVE_SP_DATA",e.$context),t.ssoServiceProviderService.getItems().pipe((0,h.switchMap)(S=>{if(S.success&&S.result.length){const[m]=S.result;return m.useJit=d.useJit,m.useSlo=d.useSlo,m.ssoIdentityProvider=d.ssoIdentityProvider,t.ssoServiceProviderService.updateItem(m)}else return d.id=(0,i.generateGuid)(),a.SpIdAttribute=d.id,t.ssoServiceProviderService.insertItem(d)})).subscribe(S=>t._onSavedSpData(S,e))})()}};b=(0,s.__decorate)([(0,i.CrtRequestHandler)({type:"crt.SaveSpDataHandler",requestType:"crt.SaveSpDataRequest",scopes:["SsoSettings","SsoSettingsV2"]}),(0,s.__param)(2,(0,i.CrtInject)(u.DEVKIT_MASK_SERVICE)),(0,s.__metadata)("design:paramtypes",[v,V.DialogService,i.MaskService])],b);let T=class extends i.BaseRequestHandler{constructor(){super(...arguments),this._listeningColumns=["SpUseJitAttribute","SpIdentityProviderAttribute"]}handle(e){var t=this;return(0,l.Z)(function*(){const a=e.$context;!e.silent&&t._listeningColumns.includes(e.attributeName)&&(a.IsSpChanged=!0);const r=yield a.IsSpChanged,n=yield a.SpIdentityProviderAttribute;return a.IsTestSsoVisible=!r&&!(0,I.isEmpty)(n),t.next?.handle(e)})()}};T=(0,s.__decorate)([(0,i.CrtRequestHandler)({type:"crt.SpDataChangeHandler",requestType:"crt.HandleViewModelAttributeChangeRequest",scopes:["SsoSettings"]})],T);let w=class extends i.BaseRequestHandler{constructor(){super(...arguments),this._listeningColumns=["SpUseJitAttribute","SpUseSloAttribute"]}handle(e){var t=this;return(0,l.Z)(function*(){const a=e.$context;return!e.silent&&t._listeningColumns.includes(e.attributeName)&&(a.IsSpChanged=!0,yield t.handlerChain.process({type:"crt.SaveSpDataRequest",$context:a,scopes:e.scopes})),t.next?.handle(e)})()}};w=(0,s.__decorate)([(0,i.CrtRequestHandler)({type:"crt.SsoSettingsV2DataChangeHandler",requestType:"crt.HandleViewModelAttributeChangeRequest",scopes:["SsoSettingsV2"]})],w);let $=class extends i.BaseRequestHandler{_tryUpdateDisplayName(e){return(0,l.Z)(function*(){if(yield e.$context.DisplayName)return;const a=yield e.$context.Type,r=yield e.$context.PartnerIdentityName;if(a&&r){const n=new URL(r).host;e.$context.DisplayName=`${n} (${a.displayValue})`}})()}handle(e){var t=this;return(0,l.Z)(function*(){return yield t._tryUpdateDisplayName(e),yield t.next?.handle(e)})()}};$=(0,s.__decorate)([(0,i.CrtRequestHandler)({type:"crt.IdpNameChangeHandler",requestType:"crt.SaveRecordRequest",scopes:["CustomIdpSettingsForm","SsoSamlBase_FormPage","SsoOpenId_FormPage","SsoOpenIdCognito_FormPage"]})],$);var oe=c(33177);let X=class extends i.BaseRequest{};X=(0,s.__decorate)([(0,i.CrtRequest)({type:"crt.TestSsoRequest"})],X);let B=class extends i.BaseRequestHandler{constructor(e,t){super(),this._window=e,this._maskService=t,this._startSsoEndpoint="/ServiceModel/AuthService.svc/StartSsoLogin",this._returnUrlHashParameterName="ReturnUrlHash",this._partnerIdpParameterName="partnerIdp"}_openUrl(e){this._window.open(e.href,"self")}_getSsoLoginUrl(e){const a=this._window.location.hash.replace("#",""),r=(0,u.getWorkspaceBaseUrl)().replace("/0/","").replace(new RegExp("/$"),""),n=new URL(r+this._startSsoEndpoint);return n.searchParams.append(this._partnerIdpParameterName,e),a&&n.searchParams.append(this._returnUrlHashParameterName,a),n}_startSsoLogin(e){const t=this._getSsoLoginUrl(e);this._openUrl(t)}handle(e){var t=this;return(0,l.Z)(function*(){const a=yield e.$context.SpIdentityProviderAttribute;let r=a&&a.value;if(r||(r=yield e.$context.Id),r){const n="TEST_SSO_HANDLER_TASK";t._maskService.showMask(n,e.$context),t._startSsoLogin(r),t._maskService.hideMask(n,e.$context)}return t.next?.handle(e)})()}};B=(0,s.__decorate)([(0,i.CrtRequestHandler)({type:"crt.TestSsoHandler",requestType:"crt.TestSsoRequest",scopes:["SsoSettings","SsoSamlBase_FormPage"]}),(0,s.__param)(0,(0,i.CrtInject)(oe.WINDOW_TOKEN)),(0,s.__param)(1,(0,i.CrtInject)(u.DEVKIT_MASK_SERVICE)),(0,s.__metadata)("design:paramtypes",[Window,i.MaskService])],B);let P=class extends i.BaseRequestHandler{_getEntitySchemaName(e){const t=this._getDataSourceName(e);return e.$context.dataSchemas[t]?.dataSourceConfig?.config?.entitySchemaName}_getDataSourceName(e){return e.$context.getBoundDataSourceName(e.itemsAttributeName)||Object.keys(e.$context.dataSchemas||{})[0]}handle(e){var t=this;return(0,l.Z)(function*(){const a=t._getEntitySchemaName(e);if(a==="SAMLFieldNameConverter"){const r={type:"crt.7XRequest",action:"OpenLookupSource",$context:e.$context,payload:{entitySchemaName:a}};return t.handlerChain.process(r)}else return t.next?.handle(e)})()}};P=(0,s.__decorate)([(0,i.CrtRequestHandler)({type:"crt.SamlDataGridRowDoubleClickHandler",requestType:"crt.DataGridRowDoubleClickRequest",scopes:["SsoSettings","SsoSettingsV2"]})],P);let f=class extends P{handle(e){var t=()=>super.handle,a=this;return(0,l.Z)(function*(){return e.itemsAttributeName==="DataGrid_SamlAttributes"?t().call(a,e):a.next?.handle(e)})()}};f.\u0275fac=function(){let o;return function(t){return(o||(o=p.\u0275\u0275getInheritedFactory(f)))(t||f)}}(),f.\u0275prov=p.\u0275\u0275defineInjectable({token:f,factory:f.\u0275fac,providedIn:"any"}),f=(0,s.__decorate)([(0,i.CrtRequestHandler)({type:"crt.OpenSamlDataGridRowHandler",requestType:"crt.UpdateRecordRequest",scopes:["SsoSettings","SsoSettingsV2"]})],f);let F=class extends i.BaseRequestHandler{constructor(e,t,a){super(),this._dialogService=e,this._service=t,this._translateService=a,this._duplicateErrorMessageCode="SsoSettings.SsoIdentityProvider.DuplicationError"}_showErrorMsg(){const e=this._translateService.instant(this._duplicateErrorMessageCode);this._dialogService.openInfoDialog(e)}handle(e){var t=this;return(0,l.Z)(function*(){const a=e.$context,r=yield a.PartnerIdentityName,n=yield a.Id;return(yield(0,h.lastValueFrom)(t._service.isUniqueIdpName(r,n,"SsoIdentityProvider","Name")))?yield t.next?.handle(e):(t._showErrorMsg(),!1)})()}};F=(0,s.__decorate)([(0,i.CrtRequestHandler)({type:"crt.IdpSaveValidationHandler",requestType:"crt.SaveRecordRequest",scopes:["CustomIdpSettingsForm"]}),(0,s.__metadata)("design:paramtypes",[V.DialogService,y,R.TranslateService])],F);let L=class extends i.BaseRequestHandler{handle(e){var t=this;return(0,l.Z)(function*(){const a=e.$context;yield a.validate();const r=yield a.getControl("AdfsUrl")?.formControl;if(!(r&&!r.valid))return t.next?.handle(e)})()}};L=(0,s.__decorate)([(0,i.CrtRequestHandler)({type:"crt.AdfsSaveValidationHandler",requestType:"crt.SaveRecordRequest",scopes:["AdfsSettingsForm","SsoSamlAdfs_FormPage"]})],L);let q=class extends i.BaseRequestHandler{constructor(e,t,a){super(),this._dialogService=e,this._service=t,this._translateService=a,this._duplicateErrorMessageCode="SsoSettings.SsoIdentityProvider.DuplicationError",this._signingSettingsErrorMessageCode="SsoSettings.SsoIdentityProvider.SigningSettingsError"}_showErrorMsg(e){this._dialogService.openInfoDialog(this._translateService.instant(e))}handle(e){var t=this;return(0,l.Z)(function*(){const a=e.$context,r=yield a.PartnerIdentityName,n=yield a.Id;if(!(yield(0,h.lastValueFrom)(t._service.isUniqueIdpName(r,n,"SsoSamlSettings","EntityID"))))return t._showErrorMsg(t._duplicateErrorMessageCode),!1;const S=yield a.WantAssertionSigned,m=yield a.PartnerCertificateThumbprint;return S&&(0,I.isEmpty)(m)?(t._showErrorMsg(t._signingSettingsErrorMessageCode),!1):yield t.next?.handle(e)})()}};q=(0,s.__decorate)([(0,i.CrtRequestHandler)({type:"crt.SamlProviderSaveValidationHandler",requestType:"crt.SaveRecordRequest",scopes:["SsoSamlBase_FormPage"]}),(0,s.__metadata)("design:paramtypes",[V.DialogService,y,R.TranslateService])],q);let Z=class extends i.BaseRequestHandler{constructor(e,t,a){super(),this._dialogService=e,this._service=t,this._translateService=a,this._duplicateErrorMessageCode="SsoSettings.SsoIdentityProvider.DuplicationError"}_showErrorMsg(){const e=this._translateService.instant(this._duplicateErrorMessageCode);this._dialogService.openInfoDialog(e)}handle(e){var t=this;return(0,l.Z)(function*(){const a=e.$context,r=yield a.Code,n=yield a.Id;return(yield(0,h.lastValueFrom)(t._service.isUniqueIdpName(r,n,"SsoProvider","Code")))?yield t.next?.handle(e):(t._showErrorMsg(),!1)})()}};Z=(0,s.__decorate)([(0,i.CrtRequestHandler)({type:"crt.SsoProviderSaveValidationHandler",requestType:"crt.SaveRecordRequest",scopes:["SsoSamlBase_FormPage","SsoOpenIdBase_FormPage"]}),(0,s.__metadata)("design:paramtypes",[V.DialogService,y,R.TranslateService])],Z);let U=class extends i.BaseRequestHandler{constructor(){super(...arguments),this._wantAssertionSignedAttributeName="WantAssertionSigned",this._wantAssertionEncryptedAttributeName="WantAssertionEncrypted",this._isSecureAttributeName="IsSecure",this.additionalParamsAttributeName="AdditionalParams"}_tryUpdateIsSecureAttribute(e){var t=this;return(0,l.Z)(function*(){const a=yield e.$context[t._wantAssertionSignedAttributeName],r=yield e.$context[t._wantAssertionEncryptedAttributeName],n=yield e.$context[t._isSecureAttributeName],d=Boolean(a)||Boolean(r);n!==d&&(e.$context[t._isSecureAttributeName]=d)})()}_tryUpdateCheckbox(e,t,a){return(0,l.Z)(function*(){const r=yield e.$context[a],n=t[a];r!==n&&(e.$context[a]=n)})()}_tryUpdateCheckboxes(e){var t=this;return(0,l.Z)(function*(){if(e.attributeName!==t.additionalParamsAttributeName)return;const a=yield t.getAdditionalParamsJson(e);!a||(yield t._tryUpdateCheckbox(e,a,t._wantAssertionSignedAttributeName),yield t._tryUpdateCheckbox(e,a,t._wantAssertionEncryptedAttributeName),e.$context[t.additionalParamsAttributeName]=JSON.stringify(a))})()}_tryUpdateAdditionalParams(e){var t=this;return(0,l.Z)(function*(){if(e.attributeName!==t._wantAssertionSignedAttributeName&&e.attributeName!==t._wantAssertionEncryptedAttributeName)return;const a=yield e.$context[e.attributeName];if(e.oldValue!==a){const r=yield t.getAdditionalParamsJson(e);if(!r)return;const n=r[e.attributeName];(!n||n!==a)&&(r[e.attributeName]=a,e.$context[t.additionalParamsAttributeName]=JSON.stringify(r))}})()}getAdditionalParamsJson(e){var t=this;return(0,l.Z)(function*(){const a=yield e.$context[t.additionalParamsAttributeName];try{return JSON.parse(a||"{}")}catch{return null}})()}handle(e){var t=this;return(0,l.Z)(function*(){return yield t._tryUpdateCheckboxes(e),yield t._tryUpdateAdditionalParams(e),yield t._tryUpdateIsSecureAttribute(e),t.next?.handle(e)})()}};U=(0,s.__decorate)([(0,i.CrtRequestHandler)({type:"crt.AdditionalParamsChangeHandler",requestType:"crt.HandleViewModelAttributeChangeRequest",scopes:["SsoSamlBase_FormPage"]})],U);let Y=class extends i.BaseRequest{};Y=(0,s.__decorate)([(0,i.CrtRequest)({type:"crt.UploadSamlIdpCertificateRequest"})],Y);let k=class extends i.BaseRequestHandler{constructor(e,t){super(),this._fileReaderService=e,this._samlIdpCertificateService=t}_selectCertificate(e){var t=this;return(0,l.Z)(function*(){const a={type:"crt.SelectFileRequest",allowedFileTypes:".cer,.der",multiple:!1,displayErrors:!1,$context:e.$context},{files:r}=yield t.handlerChain.process(a);return r})()}handle(e){var t=this;return(0,l.Z)(function*(){const a=yield t._selectCertificate(e);if(!a||a.length===0)return;const r=yield e.$context.IdpCertificatesDataGrid,n=yield(0,h.lastValueFrom)((0,h.from)(a).pipe((0,x.mergeMap)(d=>t._fileReaderService.read(d)),(0,x.mergeMap)(d=>(0,h.from)(t._samlIdpCertificateService.addCertificateToCollection(r,d)))));(0,I.isEmpty)(n)||(e.$context.PartnerCertificateThumbprint=n,e.$context.WantAssertionSigned=!0),yield t.next?.handle(e)})()}};k=(0,s.__decorate)([(0,i.CrtRequestHandler)({type:"crt.UploadSamlIdpCertificateHandler",requestType:"crt.UploadSamlIdpCertificateRequest",scopes:["SsoSamlBase_FormPage"]}),(0,s.__metadata)("design:paramtypes",[u.FileReaderService,_])],k);let J=class extends i.BaseRequestHandler{constructor(e,t){super(),this._httpClient=e,this._queryExecutor=t,this._samlMetadataUrl="/rest/SamlIdpService/UploadIdpCertificate"}_uploadCertificate(e,t,a){var r=this;return(0,l.Z)(function*(){const n=yield a.fileDto,d=new g.HttpParams({encoder:new u.FileApiHttpParamEncoder}).set("totalFileLength",n.file.size).set("parentColumnValue",e).set("fileId",t).set("fileName",n.file.name);return(0,h.lastValueFrom)(r._httpClient.post(r._samlMetadataUrl,n.content,{headers:new g.HttpHeaders({"Content-Range":`bytes 0/${n.file.size}`,"Content-Type":n.file.type,"Content-Disposition":`attachment; filename=${encodeURIComponent(n.file.name)}`}),params:d}))})()}_getIdpId(e){return(0,l.Z)(function*(){const t=yield e.$context.getPrimaryDataSchema();return e.$context[t.primaryAttributeName]})()}handle(e){var t=this;return(0,l.Z)(function*(){if(e.collectionAttributeName!=="IdpCertificatesDataGrid")return yield t.next?.handle(e);const a=yield e.$context[e.collectionAttributeName],r=a.getChangedItems(),n=yield t._getIdpId(e),d=[],S=new i.DeleteQuery("SamlIdpCertificateView");S.filters.addSchemaColumnFilterWithParameter(i.ComparisonType.Equal,"SsoSamlSettings",n);for(const m of r){const ie=(0,i.generateGuid)(),ne=yield t._uploadCertificate(n,ie,m);(0,I.isEmpty)(ne)||(a.removeChildModel(m),a.remove(m),S.filters.addSchemaColumnFilterWithParameter(i.ComparisonType.Not_equal,"Id",ie)),d.push({success:!(0,I.isEmpty)(ne),rowsAffected:1})}return d.filter(m=>m.success).length>0&&(yield(0,h.lastValueFrom)(t._queryExecutor.executeDeleteQuery(S))),d})()}};J=(0,s.__decorate)([(0,i.CrtRequestHandler)({type:"crt.SaveSamlIdpCertificatesHandler",requestType:"crt.SaveCollectionPrimaryDataRequest",scopes:["SsoSamlBase_FormPage"]}),(0,s.__metadata)("design:paramtypes",[g.HttpClient,E.QueryExecutor])],J);let ee=class extends i.BaseRequest{};ee=(0,s.__decorate)([(0,i.CrtRequest)({type:"crt.UploadSamlIdpMetadataRequest"})],ee);let j=class extends i.BaseRequestHandler{constructor(e,t,a){super(),this._httpClient=e,this._fileReaderService=t,this._samlIdpCertificateService=a,this._uploadMetadataUrl="/rest/SamlIdpService/ParseIdpMetadata"}_selectMetadata(e){var t=this;return(0,l.Z)(function*(){const a={type:"crt.SelectFileRequest",allowedFileTypes:".xml",multiple:!1,displayErrors:!1,$context:e.$context},{files:r}=yield t.handlerChain.process(a);return r})()}_parceMetadata(e){const t=new g.HttpParams({encoder:new u.FileApiHttpParamEncoder}).set("totalFileLength",e.file.size).set("fileName",e.file.name);return this._httpClient.post(this._uploadMetadataUrl,e.content,{headers:new g.HttpHeaders({"Content-Range":`bytes 0/${e.file.size}`,"Content-Type":e.file.type,"Content-Disposition":`attachment; filename=${encodeURIComponent(e.file.name)}`}),params:t})}_parseMetadata(e){return(0,h.lastValueFrom)((0,h.from)(e).pipe((0,x.mergeMap)(t=>this._fileReaderService.read(t)),(0,x.mergeMap)(t=>this._parceMetadata(t))))}_getCertificateContent(e){let t=new Uint8Array(e);if(t.length>0)return t;const a=window.atob(e);t=new Uint8Array(a.length);for(let r=0;r<a.length;r++)t[r]=a.charCodeAt(r);return t}_addCertificates(e,t){var a=this;return(0,l.Z)(function*(){if(!t.PartnerCertificates||t.PartnerCertificates.length===0)return;const r=yield e.$context.IdpCertificatesDataGrid,n=yield Promise.all(t.PartnerCertificates.map(S=>a._samlIdpCertificateService.addCertificateToCollection(r,{file:new File([S.RawData],"certificate.cer"),content:a._getCertificateContent(S.RawData).buffer}))),d=n?.length>0?n[0]:"";(0,I.isEmpty)(d)||(e.$context.PartnerCertificateThumbprint=d,e.$context.WantAssertionSigned=!0)})()}handle(e){var t=this;return(0,l.Z)(function*(){const a=yield t._selectMetadata(e);if(!a||a.length===0)return;const r=yield t._parseMetadata(a);e.$context.PartnerIdentityName=r.EntityID,e.$context.SingleSignOnServiceUrl=r.SingleSignOnServiceUrl,e.$context.SingleLogoutServiceUrl=r.SingleLogoutServiceUrl,yield t._addCertificates(e,r),yield t.next?.handle(e)})()}};j=(0,s.__decorate)([(0,i.CrtRequestHandler)({type:"crt.UploadSamlIdpMetadataHandler",requestType:"crt.UploadSamlIdpMetadataRequest",scopes:["SsoSamlBase_FormPage"]}),(0,s.__metadata)("design:paramtypes",[g.HttpClient,u.FileReaderService,_])],j);let G=class extends U{constructor(){super(...arguments),this._defaultAdfsAdditionalParams={SignLogoutRequest:!0,SignLogoutResponse:!0},this._primaryModelModeAttrName="PrimaryModelMode"}_setDefaultAdditionalParams(e){Object.assign(e,this._defaultAdfsAdditionalParams)}handle(e){var t=this;return(0,l.Z)(function*(){if(e.attributeName===t._primaryModelModeAttrName){const r=e.$context;if(r.getPrimaryModelMode()===u.ModelMode.Create){const d=(yield t.getAdditionalParamsJson(e))??{};t._setDefaultAdditionalParams(d),r[t.additionalParamsAttributeName]=JSON.stringify(d)}}return t.next?.handle(e)})()}};G=(0,s.__decorate)([(0,i.CrtRequestHandler)({type:"crt.AdfsAdditionalParamsChangeHandler",requestType:"crt.HandleViewModelAttributeChangeRequest",scopes:["SsoSamlAdfs_FormPage"]})],G);var te=c(24709);let O=class extends te.EmptyWhiteSpaceValidator{constructor(){super(...arguments),this.i18nMessageKey="SsoSettings.Validators.AdfsTenant.Message",this.async=!1}validate(e,t){const a=super.validate(e);return a||(e.value.trim().startsWith("http")?{required:this.defaultValidationError(t)}:null)}};O=(0,s.__decorate)([(0,i.CrtValidator)({type:"crt.AdfsTenantValidator"})],O);let W=class extends te.EmptyWhiteSpaceValidator{constructor(){super(...arguments),this.i18nMessageKey="SsoSettings.Validators.StringUrl.Message",this.async=!1}validate(e,t){const a=super.validate(e);if(a)return a;const r=e.value;try{new URL(r)}catch{return{required:this.defaultValidationError(t)}}return null}};W=(0,s.__decorate)([(0,i.CrtValidator)({type:"crt.StringUrlValidator"})],W);let K=class extends te.AngularBaseValidator{constructor(e){super(e),this.injector=e,this.i18nMessageKey="SsoSettings.Validators.IsJsonValidator.Message",this.async=!1,this._translateService=e?.get(R.TranslateService)}validate(e,t){const a=e.value;if((0,I.isEmpty)(a)&&t?.skipEmptyValues)return null;try{JSON.parse(a===null?"":a)}catch{return{IsJson:{message:this._translateService?.instant(this.i18nMessageKey)||""}}}return null}};K=(0,s.__decorate)([(0,i.CrtValidator)({type:"crt.IsJsonValidator"}),(0,s.__metadata)("design:paramtypes",[p.Injector])],K);var re=c(31134);let C=class{};C.\u0275fac=function(e){return new(e||C)},C.\u0275mod=p.\u0275\u0275defineNgModule({type:C}),C.\u0275inj=p.\u0275\u0275defineInjector({providers:[_,v,A,y],imports:[re.CommonModule,g.HttpClientModule]}),C=(0,s.__decorate)([(0,i.CrtModule)({requestHandlers:[M,D,N,b,T,w,B,$,F,P,f,L,Z,q,U,k,J,j,G],validators:[O,W,K]})],C),function(){(typeof ngJitMode>"u"||ngJitMode)&&p.\u0275\u0275setNgModuleScope(C,{imports:[re.CommonModule,g.HttpClientModule]})}();class de{constructor(){this.ssoIdentityProvider={},this.useJit=!1,this.useSlo=!1,this.name="",this.assertionConsumerServiceUrl="",this.singleLogoutServiceUrl=""}}}}]);
