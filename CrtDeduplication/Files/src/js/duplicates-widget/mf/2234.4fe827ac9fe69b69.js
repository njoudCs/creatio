(self.webpackChunkapp_studio_enterprise_duplicates_widget=self.webpackChunkapp_studio_enterprise_duplicates_widget||[]).push([[2234],{82234:($e,fe,f)=>{f.r(fe),f.d(fe,{BaseDataGridStateHandlerService:()=>Y,BooleanCellViewElementConfigCreator:()=>z,BooleanEditingCellViewElementConfigCreator:()=>L,CAN_CREATE_DEFAULT_GRID_SETTING_OPERATION_CODE:()=>be,CHECK_DATA_GRID_COLUMNS_RIGHTS_ON_LOAD:()=>ye,CellViewElementConfigCreator:()=>h,CrtDataGridCdkModule:()=>T,DATA_GRID_AVAILABLE_EDITING_DATA_VALUE_TYPES:()=>De,DATA_GRID_CELL_VIEW_CONFIG_CREATOR_FACTORY:()=>re,DATA_GRID_CELL_VIEW_CONFIG_CREATOR_FACTORY_PROVIDER:()=>Fe,DATA_GRID_EDITING_CELL_VIEW_CONFIG_CREATOR_FACTORY:()=>he,DATA_GRID_EDITING_CELL_VIEW_CONFIG_CREATOR_FACTORY_PROVIDER:()=>Re,DISABLE_DATA_GRID_EDITING_MODE_FEATURE_CODE:()=>Ae,DISABLE_DATA_GRID_MULTIPLE_ROWS_SELECTION_FEATURE_CODE:()=>we,DataGridCancelItemsChangesHandler:()=>ce,DataGridCancelItemsChangesRequest:()=>Ce,DataGridColumnDefinitionService:()=>K,DataGridRowDoubleClickHandler:()=>le,DataGridRowDoubleClickRequest:()=>me,DateTimeCellViewElementConfigCreator:()=>P,DateTimeEditingCellViewElementConfigCreator:()=>G,DcmStageCellViewElementConfigCreator:()=>b,DcmStageEditingCellViewElementConfigCreator:()=>$,EditingCellViewElementConfigCreator:()=>y,EmailCellViewElementConfigCreator:()=>I,EmailEditingCellViewElementConfigCreator:()=>O,FILE_LIST_CELL_VIEW_CONFIG_CREATOR_FACTORY:()=>_e,FILE_LIST_CELL_VIEW_CONFIG_CREATOR_FACTORY_PROVIDER:()=>Ge,FileCellViewElementConfigCreator:()=>v,FileSizeCellViewElementConfigCreator:()=>A,GRID_VIEW_ELEMENT_TYPES:()=>pe,LookupCellViewElementConfigCreator:()=>Z,LookupEditingCellViewElementConfigCreator:()=>R,NativeLinkCellViewElementConfigCreator:()=>X,NumericCellViewElementConfigCreator:()=>U,NumericEditingCellViewElementConfigCreator:()=>F,PhoneCellViewElementConfigCreator:()=>V,PhoneEditingCellViewElementConfigCreator:()=>x,PrimaryCellViewElementConfigCreator:()=>H,RichTextCellViewElementConfigCreator:()=>w,SchemaDataGridColumnEditHandler:()=>q,SchemaDataGridColumnSelectionService:()=>ee,StructureExplorerDataGridColumnSelectionService:()=>J,TextCellViewElementConfigCreator:()=>k,TextEditingCellViewElementConfigCreator:()=>N,WebEditingCellViewElementConfigCreator:()=>M,getDataGridViewConfigs:()=>Ee,getDataGridViewConfigsWithItemsBinding:()=>Se,getViewModelItemsAttributeName:()=>ne});var i=f(94450),D=f(14537),j=f(52045),m=f(21322),g=f(27049);function ne(n){const{items:e}=n||{};if(typeof e!="string"){console.log(`The type '${typeof e}' of 'items' attribute binding value is not supporting.`);return}if(e.startsWith("$")===!1){console.log(`The attribute value '${e}' of the 'items' is not supporting. The attribute value should be bindable (starts with a "$" character)`);return}return e.substring(1)}var E=f(49475);const pe=["crt.DataGrid","crt.FileList","crt.ApprovalList"];function Ee(n,e){const{viewConfig:t}=n;return e=e&&e.length>0?e:void 0,E.MetadataSchemaUtils.getViewConfigInfoByPropertyForValues("type",e||pe,t).filter(a=>Boolean(a)).map(({viewConfig:a})=>a).filter(({name:a})=>a)||[]}function Se(n,e){const{viewModelConfig:t}=n;return Ee(n,e).filter(({items:a})=>(0,D.isBindToViewModelAttribute)(a,t.attributes))}class Y{constructor(e){this.schemaService=e}getColumnsFromSchema(e){const t=e?.columns??[];if(typeof t=="string"){const a=t.split("$").pop();return this._getViewModel().pipe((0,g.map)(r=>(r?.attributes??{})[a]||[]))}return(0,m.of)(t)}_getViewModel(){return this.injector?this.injector.get(D.BINDING_CONTEXT).viewModel$.pipe((0,g.take)(1)):(0,m.of)(null)}getDataSourceName(e){const t=ne(e);return this._getViewModel().pipe((0,g.map)(a=>a?.getBoundDataSourceName(t)))}handle(e,t){this.injector=t;const a=t.get(D.VIEW_ELEMENT_CONFIG),r=this.schemaService.getViewConfigInfoByName(a.name).viewConfig,o=e.columns??[];return this.getDataSourceName(r).pipe((0,g.switchMap)(l=>l?this.getColumnsFromSchema(r).pipe((0,g.switchMap)(s=>{const u={viewElementConfig:r,dataSourceName:l,columns:o,previousColumns:s};return this.innerHandle(u)})):(0,m.of)(void 0)))}}Y.\u0275fac=function(e){return new(e||Y)(i.\u0275\u0275inject(j.SchemaService))},Y.\u0275prov=i.\u0275\u0275defineInjectable({token:Y,factory:Y.\u0275fac});var c=f(75378),se=f(77207),Ve=f(18369),ue=f(33177),Ie=f(96923),B=f(34038),ve=f(54134);const re=new i.InjectionToken("A cell view config factory"),he=new i.InjectionToken("A factory of editing cell view config creators"),_e=new i.InjectionToken("A cell view config factory");class J{constructor(e,t,a,r){this.structureExplorer=e,this.schemaService=t,this.cellViewConfigCreatorFactory=a,this.translateService=r}_openStructureExplorer(e){return this.structureExplorer.show({providers:[e],enableMultiSelection:!0,collectDrillDownItems:!0})}_getColumnCaptionResourceMacros(e,t){const a=t.split(".").join("");return`#ResourceString(${e}_${a})#`}_getStructureExplorerDataProviderConfig(e,t){const a=e.getBoundDataSourceNameByAttributePath(t);return{name:Ie.DATA_SOURCE_STRUCTURE_EXPLORER_DATA_PROVIDER_NAME,navigateOnlyThroughDataSource:a,options:{useBackwards:!0}}}_modifyAggregationColumnCode(e,t){return e+t+ve.Guid.create().toString().slice(0,8)}createColumnDefinition(e){const{structureExplorerItem:t,dataSourceName:a}=e,r=this.getColumnName(t.columnPath),o=t.data?.item?.aggregationFunction;let l=`${a}_${r}`;o&&(l=this._modifyAggregationColumnCode(l,o));const s=t.data.dataValueType,u=o?this.getAggregationColumnCaption(t.caption,t.data.item.aggregationFunctionCaption,t.data.item.aggregationFunction):this._getColumnCaptionResourceMacros(a,r),C=t.data.isMasked,p={id:(0,c.generateGuid)(),code:l,path:t.columnPath,caption:u,dataValueType:s,referenceSchemaName:t.data?.item?.referenceSchemaName,isMasked:C};return o&&(p.aggregationConfig={aggregationFunction:t.data?.item?.aggregationFunction},o===c.AggregationFunction.TopOne&&(p.aggregationConfig.sortByColumn="Id",p.aggregationConfig.sortByDirection=c.OrderDirection.Asc),p.captionResources=new E.LocalizableStringArray,p.captionResources.setValueLocalizableString(this.translateService.currentLang,this.getAggregationColumnCaption(t.caption,t.data.item.aggregationFunctionCaption,t.data.item.aggregationFunction)),p.captionResourcesChanged=!0),{...p}}getItemsAttributeName(e){const t=e.get(D.VIEW_ELEMENT_CONFIG),a=this.schemaService.getViewConfigInfoByName(t.name).viewConfig;return ne(a)}getAggregationColumnCaption(e,t,a){return a===c.AggregationFunction.TopOne?this.translateService.currentLang===E.DEFAULT_CULTURE_NAME?`${e} (the ${t.toLowerCase()})`:`${e} (${t.toLowerCase()})`:`${e} ${t}`}getColumnName(e){return(0,E.removeSpecialSymbols)(e)}selectColumns(e){const a=e.get(D.BINDING_CONTEXT).viewModel$.pipe((0,g.take)(1)),r=this.getItemsAttributeName(e);if(!r)return(0,m.of)([]);const o=a.pipe((0,g.map)(s=>s?.getBoundDataSourceNameByAttributePath(r))),l=a.pipe((0,g.map)(s=>this._getStructureExplorerDataProviderConfig(s,r)),(0,g.switchMap)(s=>this._openStructureExplorer(s)));return(0,m.forkJoin)([l,o]).pipe((0,g.map)(([s,u])=>(s??[]).filter(C=>C.id!==u).map(C=>this.createColumnDefinition({structureExplorerItem:C,dataSourceName:u}))))}}J.\u0275fac=function(e){return new(e||J)(i.\u0275\u0275inject(Ve.StructureExplorerService),i.\u0275\u0275inject(j.SchemaService),i.\u0275\u0275inject(re),i.\u0275\u0275inject(se.TranslateService))},J.\u0275prov=i.\u0275\u0275defineInjectable({token:J,factory:J.\u0275fac});var d=f(8239);class h{constructor(){this.type=""}getDisplayValue(e){const{column:t,itemsAttributeName:a}=e??{};return`${a}.${t?.code}`}getViewElementConfig(e){var t=this;return(0,d.Z)(function*(){const{column:a}=e??{};return{column:{...a},value:t.getDisplayValue(e),type:t.type}})()}}class k extends h{constructor(){super(...arguments),this.type="crt.TableTextCell"}}k.\u0275fac=function(){let n;return function(t){return(n||(n=i.\u0275\u0275getInheritedFactory(k)))(t||k)}}(),k.\u0275prov=i.\u0275\u0275defineInjectable({token:k,factory:k.\u0275fac,providedIn:"root"});class P extends h{constructor(){super(...arguments),this.type="crt.TableDateTimeCell"}}P.\u0275fac=function(){let n;return function(t){return(n||(n=i.\u0275\u0275getInheritedFactory(P)))(t||P)}}(),P.\u0275prov=i.\u0275\u0275defineInjectable({token:P,factory:P.\u0275fac,providedIn:"root"});class U extends h{constructor(){super(...arguments),this.type="crt.TableNumericCell"}}U.\u0275fac=function(){let n;return function(t){return(n||(n=i.\u0275\u0275getInheritedFactory(U)))(t||U)}}(),U.\u0275prov=i.\u0275\u0275defineInjectable({token:U,factory:U.\u0275fac,providedIn:"root"});var de=f(24709);class W extends h{constructor(){super(),this.type="crt.Link"}hasSectionEditPage(e){var t=this;return(0,d.Z)(function*(){const a=yield t.getReferenceSchemaName(e),r={type:"crt.7XRequest",action:"HasEntityEditPage",$context:e.context,payload:{entityName:a}};return yield c.HandlerChainService.instance.process(r)})()}getDefaultViewElementConfig(e){var t=()=>super.getViewElementConfig,a=this;return(0,d.Z)(function*(){const r=yield t().call(a,e);return r.type="crt.TableTextCell",r})()}getViewElementConfig(e){var t=this;return(0,d.Z)(function*(){return(yield t.hasSectionEditPage(e))?t.getLinkViewElementConfig(e):t.getDefaultViewElementConfig(e)})()}}W.\u0275fac=function(e){return new(e||W)},W.\u0275prov=i.\u0275\u0275defineInjectable({token:W,factory:W.\u0275fac});class H extends W{constructor(){super()}getReferenceSchemaName(e){return(0,d.Z)(function*(){const t=e?.primaryAttributeName??"";return(yield(0,de.getEntitySchemaAttribute)(e.context,e.itemsAttributeName.substring(1)+"."+t))?.referenceSchemaName})()}getLinkViewElementConfig(e){var t=this;return(0,d.Z)(function*(){const{itemsAttributeName:a,primaryAttributeName:r,column:o}=e,l=t.getDisplayValue(e);return{column:o,caption:l,type:t.type,href:`${a}.${r} | crt.ToRecordLinkAsync : '${r}'`,mode:"preventDefault",clicked:{request:"crt.UpdateRecordRequest",params:{itemsAttributeName:a.slice(1),recordId:`${a}.${r}`}}}})()}}H.\u0275fac=function(e){return new(e||H)},H.\u0275prov=i.\u0275\u0275defineInjectable({token:H,factory:H.\u0275fac,providedIn:"root"});var ie=f(41307);class Z extends W{constructor(e,t,a){super(),this._featureService=e,this._entitySchemaRepository=t,this._dcmSchemaManagerService=a,this._colorizedSchemasMap=new Map,this.type="crt.Link"}_isColumnColorized(e){var t=this;return(0,d.Z)(function*(){const a=yield(0,m.lastValueFrom)(t._featureService.getFeatureState("DisableDataGridColoredCell")),r=yield t.getReferenceSchemaName(e);if(!r||a)return Promise.resolve(!1);const o=t._colorizedSchemasMap.get(r);return o!==void 0?o:(0,m.lastValueFrom)(t._entitySchemaRepository.getSchemaByName(r).pipe((0,m.map)(l=>{const s=!!l.getPrimaryColorColumn();return t._colorizedSchemasMap.set(r,s),s}),(0,m.catchError)(()=>(0,m.of)(!1))))})()}_decorateConfigWithColorization(e,t){const a=super.getDisplayValue(t);e.type="crt.TableColoredCell",e.displayValue=a}_isStageColumn(e){var t=this;return(0,d.Z)(function*(){const a=yield(0,m.lastValueFrom)(t._featureService.getFeatureState("DisableDataGridProgressBarStageCell"));if(!e.dataGridSchemaName||a)return Promise.resolve(!1);const r=yield(0,m.firstValueFrom)(t._entitySchemaRepository.getSchemaByName(e.dataGridSchemaName)),o=(yield(0,m.firstValueFrom)(t._dcmSchemaManagerService.getDcmSchemaDataCollection())).find(s=>s.entitySchemaUId===r.uId);if(!o)return Promise.resolve(!1);const l=r.columns?.find(s=>s.uId===o.stageColumnUId)?.name;return l?e.column.code.split("_").pop()===l:Promise.resolve(!1)})()}_decorateConfigWithSlider(e,t){const a=`${t.dataGridName}_DCMData`;e.type="crt.TableSliderCell";const r=t.column?.code??"",l=`${`${t.itemsAttributeName}.${r}`} | crt.ToEntityStageDataTableSliderConverterAsync:$${a}`;e.percentage=`${l} | crt.ToObjectProp : 'value'`,e.color=`${l} | crt.ToObjectProp : 'color'`,e.value=this.getDisplayValue(t)}getDisplayValue(e){return`${super.getDisplayValue(e)} | crt.ToObjectProp : 'displayValue'`}getReferenceSchemaName(e){return(0,d.Z)(function*(){const t=e?.column.code??"";return(yield(0,de.getEntitySchemaAttribute)(e.context,e.itemsAttributeName.substring(1)+"."+t))?.referenceSchemaName})()}getDefaultViewElementConfig(e){var t=()=>super.getDefaultViewElementConfig,a=this;return(0,d.Z)(function*(){const r=yield t().call(a,e),o=yield a._isColumnColorized(e);return(yield a._isStageColumn(e))?a._decorateConfigWithSlider(r,e):o&&a._decorateConfigWithColorization(r,e),r})()}getLinkViewElementConfig(e){var t=this;return(0,d.Z)(function*(){const{itemsAttributeName:a,column:r}=e,o=t.getDisplayValue(e),l=yield t.getReferenceSchemaName(e),s=r?.code??"",u=`${a}.${s} | crt.ToObjectProp : 'value' | crt.ToRecordLinkAsync : '${s}'`,C={type:"crt.Link",column:{...r},caption:o,href:u,mode:"preventDefault",clicked:{request:"crt.UpdateRecordRequest",params:{entityName:l,recordId:`${a}.${s} | crt.ToObjectProp : "value"`}}},p=yield t._isColumnColorized(e);return(yield t._isStageColumn(e))?t._decorateConfigWithSlider(C,e):p&&t._decorateConfigWithColorization(C,e),C})()}}Z.\u0275fac=function(e){return new(e||Z)(i.\u0275\u0275inject(ie.FeatureService),i.\u0275\u0275inject(E.EntitySchemaRepository),i.\u0275\u0275inject(ie.DcmSchemaManagerService))},Z.\u0275prov=i.\u0275\u0275defineInjectable({token:Z,factory:Z.\u0275fac,providedIn:"root"});class z extends h{constructor(e){super(),this._defaultFeatures=e,this.type="crt.TableBooleanCell"}_getEditingModeDisabledExpression(e){if((0,j.isBindingExpression)(e))return`${e} | crt.PickDataGridFeatureValue : 'editable.enable' | crt.InvertBooleanValue`;const t=(0,B.fullInDataTableEditingFeatures)(e?.editable,!0);return!(0,B.fullInDataTableEditingFeatures)(this._defaultFeatures?.editable,!1).enable||!t.enable}getViewElementConfig(e){var t=()=>super.getViewElementConfig,a=this;return(0,d.Z)(function*(){const r=yield t().call(a,e),o=a.getDisplayValue(e),l=e.column.readonly===!0,s=a._getEditingModeDisabledExpression(e.features);return{...r,control:o,readonly:l||s,bindTo:o}})()}}z.\u0275fac=function(e){return new(e||z)(i.\u0275\u0275inject(B.DATA_GRID_FEATURES,8))},z.\u0275prov=i.\u0275\u0275defineInjectable({token:z,factory:z.\u0275fac,providedIn:"root"});class V extends h{constructor(){super(...arguments),this.type="crt.TablePhoneCell"}}V.\u0275fac=function(){let n;return function(t){return(n||(n=i.\u0275\u0275getInheritedFactory(V)))(t||V)}}(),V.\u0275prov=i.\u0275\u0275defineInjectable({token:V,factory:V.\u0275fac,providedIn:"root"});class I extends h{constructor(){super(...arguments),this.type="crt.TableEmailCell"}}I.\u0275fac=function(){let n;return function(t){return(n||(n=i.\u0275\u0275getInheritedFactory(I)))(t||I)}}(),I.\u0275prov=i.\u0275\u0275defineInjectable({token:I,factory:I.\u0275fac,providedIn:"root"});class v extends h{constructor(){super(...arguments),this.type="crt.TableFileCell"}getViewElementConfig(e){var t=this;return(0,d.Z)(function*(){const{itemsAttributeName:a,primaryAttributeName:r,dataSchemaName:o,column:l}=e;return{column:{...l},fileName:t.getDisplayValue(e),fileUrl:`${a}.${r} | crt.ToFileLink : '${o}'`,type:t.type}})()}}v.\u0275fac=function(){let n;return function(t){return(n||(n=i.\u0275\u0275getInheritedFactory(v)))(t||v)}}(),v.\u0275prov=i.\u0275\u0275defineInjectable({token:v,factory:v.\u0275fac,providedIn:"root"});class A extends h{constructor(){super(...arguments),this.type="crt.TableFileSizeCell"}}A.\u0275fac=function(){let n;return function(t){return(n||(n=i.\u0275\u0275getInheritedFactory(A)))(t||A)}}(),A.\u0275prov=i.\u0275\u0275defineInjectable({token:A,factory:A.\u0275fac,providedIn:"root"});class w extends h{constructor(){super(...arguments),this.type="crt.TableRichTextEditorCell"}}w.\u0275fac=function(){let n;return function(t){return(n||(n=i.\u0275\u0275getInheritedFactory(w)))(t||w)}}(),w.\u0275prov=i.\u0275\u0275defineInjectable({token:w,factory:w.\u0275fac,providedIn:"root"});class X extends h{constructor(){super(),this.type="crt.Link"}getViewElementConfig(e){var t=()=>super.getViewElementConfig,a=this;return(0,d.Z)(function*(){const r=yield t().call(a,e),o=e.column.dataValueType===c.DataValueType.EMAIL_TEXT;return r.href=o?`${r.value} | crt.ToEmailLink`:`${r.value} | crt.LinkPrefix`,r.caption=`${r.value}`,r.mode="native",r.target=o?"_self":"_blank",r})()}}X.\u0275fac=function(e){return new(e||X)},X.\u0275prov=i.\u0275\u0275defineInjectable({token:X,factory:X.\u0275fac,providedIn:"root"});class b extends h{constructor(){super(...arguments),this.type="crt.TableDcmStageCell"}getViewElementConfig(e){var t=()=>super.getViewElementConfig,a=this;return(0,d.Z)(function*(){const r=yield t().call(a,e),o=a.getDisplayValue(e);return{...r,value:o,bindTo:o,dcmStages:"$DcmStages"}})()}}b.\u0275fac=function(){let n;return function(t){return(n||(n=i.\u0275\u0275getInheritedFactory(b)))(t||b)}}(),b.\u0275prov=i.\u0275\u0275defineInjectable({token:b,factory:b.\u0275fac,providedIn:"root"});class y{constructor(){this.type=""}getViewElementConfig(e){var t=this;return(0,d.Z)(function*(){const{column:a,itemsAttributeName:r}=e??{};return{type:t.type,control:`${r}.${a.code}`,bindTo:`${r}.${a.code}`}})()}}class N extends y{constructor(){super(...arguments),this.type="crt.DataTableEditTextCell"}}N.\u0275fac=function(){let n;return function(t){return(n||(n=i.\u0275\u0275getInheritedFactory(N)))(t||N)}}(),N.\u0275prov=i.\u0275\u0275defineInjectable({token:N,factory:N.\u0275fac,providedIn:"root"});class F extends y{constructor(){super(...arguments),this.type="crt.DataTableEditNumericCell"}}F.\u0275fac=function(){let n;return function(t){return(n||(n=i.\u0275\u0275getInheritedFactory(F)))(t||F)}}(),F.\u0275prov=i.\u0275\u0275defineInjectable({token:F,factory:F.\u0275fac,providedIn:"root"});class R extends y{constructor(){super(...arguments),this.type="crt.DataTableEditLookupCell"}}R.\u0275fac=function(){let n;return function(t){return(n||(n=i.\u0275\u0275getInheritedFactory(R)))(t||R)}}(),R.\u0275prov=i.\u0275\u0275defineInjectable({token:R,factory:R.\u0275fac,providedIn:"root"});class G extends y{constructor(){super(...arguments),this._dataValueTypeToDateType=new Map([[c.DataValueType.Date,E.DateTypes.Date],[c.DataValueType.Time,E.DateTypes.Time],[c.DataValueType.DateTime,E.DateTypes.DateTime]]),this.type="crt.DataTableEditDateTimeCell"}getViewElementConfig(e){var t=()=>super.getViewElementConfig,a=this;return(0,d.Z)(function*(){const{column:r}=e??{};return{...yield t().call(a,e),dateType:a._dataValueTypeToDateType.get(r.dataValueType)??E.DateTypes.DateTime}})()}}G.\u0275fac=function(){let n;return function(t){return(n||(n=i.\u0275\u0275getInheritedFactory(G)))(t||G)}}(),G.\u0275prov=i.\u0275\u0275defineInjectable({token:G,factory:G.\u0275fac,providedIn:"root"});class L extends y{getViewElementConfig(e){return(0,d.Z)(function*(){return null})()}}L.\u0275fac=function(){let n;return function(t){return(n||(n=i.\u0275\u0275getInheritedFactory(L)))(t||L)}}(),L.\u0275prov=i.\u0275\u0275defineInjectable({token:L,factory:L.\u0275fac,providedIn:"root"});class x extends y{constructor(){super(...arguments),this.type="crt.DataTableEditPhoneCell"}getViewElementConfig(e){var t=()=>super.getViewElementConfig,a=this;return(0,d.Z)(function*(){if(!e?.context)return null;const r=yield t().call(a,e),o=e.context.getBoundDataSchemaByAttributePath(e.itemsAttributeName.split("$")[1]),{path:l}=e.column,s=o?.attributes.find(u=>u.path===l)?.isMasked;return{...r,displayAsPhone:s}})()}}x.\u0275fac=function(){let n;return function(t){return(n||(n=i.\u0275\u0275getInheritedFactory(x)))(t||x)}}(),x.\u0275prov=i.\u0275\u0275defineInjectable({token:x,factory:x.\u0275fac,providedIn:"root"});class O extends y{constructor(){super(...arguments),this.type="crt.DataTableEditEmailCell"}getViewElementConfig(e){var t=()=>super.getViewElementConfig,a=this;return(0,d.Z)(function*(){if(!e?.context)return null;const r=yield t().call(a,e),o=e.context.getBoundDataSchemaByAttributePath(e.itemsAttributeName.split("$")[1]),{path:l}=e.column,s=o?.attributes.find(u=>u.path===l)?.isFormatValidated;return{...r,isFormatValidated:s}})()}}O.\u0275fac=function(){let n;return function(t){return(n||(n=i.\u0275\u0275getInheritedFactory(O)))(t||O)}}(),O.\u0275prov=i.\u0275\u0275defineInjectable({token:O,factory:O.\u0275fac,providedIn:"root"});class M extends y{constructor(){super(...arguments),this.type="crt.DataTableEditWebCell"}}M.\u0275fac=function(){let n;return function(t){return(n||(n=i.\u0275\u0275getInheritedFactory(M)))(t||M)}}(),M.\u0275prov=i.\u0275\u0275defineInjectable({token:M,factory:M.\u0275fac,providedIn:"root"});class $ extends y{constructor(){super(...arguments),this.type="crt.TableDcmStageEditingCell"}getViewElementConfig(e){var t=()=>super.getViewElementConfig,a=this;return(0,d.Z)(function*(){return{...yield t().call(a,e),column:{},dcmStages:"$DcmStages"}})()}}$.\u0275fac=function(){let n;return function(t){return(n||(n=i.\u0275\u0275getInheritedFactory($)))(t||$)}}(),$.\u0275prov=i.\u0275\u0275defineInjectable({token:$,factory:$.\u0275fac,providedIn:"root"});var oe=f(97600);const ye="CheckDataGridColumnsRightsOnLoad",Ae="DisableDataGridEditingMode",we="DisableDataGridMultipleRowsSelection",be="CanCreateDefaultGridSettings",De=[c.DataValueType.Guid,c.DataValueType.Text,c.DataValueType.Integer,c.DataValueType.Float,c.DataValueType.Money,c.DataValueType.DateTime,c.DataValueType.Date,c.DataValueType.Time,c.DataValueType.Lookup,c.DataValueType.Enum,c.DataValueType.Boolean,c.DataValueType.SHORT_TEXT,c.DataValueType.MEDIUM_TEXT,c.DataValueType.MAXSIZE_TEXT,c.DataValueType.LONG_TEXT,c.DataValueType.FLOAT1,c.DataValueType.FLOAT2,c.DataValueType.FLOAT3,c.DataValueType.FLOAT4,c.DataValueType.FLOAT8,c.DataValueType.PHONE_TEXT,c.DataValueType.WEB_TEXT,c.DataValueType.EMAIL_TEXT];class K{constructor(e,t,a){this._cellViewConfigCreatorFactory=e,this._rightsService=t,this._featureService=a}_getColumnName(e){return e.dataValueType===c.DataValueType.Lookup?`${e.path}Id`:e.path}_getColumnsAccessRights(e){const t=(0,oe.uniq)(e.attributes.map(this._getColumnName));return this._featureService.getFeatureState(ye).pipe((0,g.switchMap)(r=>r?this._requestColumnsAccessRights(e.name,t):this._allowColumnsAccessRights(t)))}_allowColumnsAccessRights(e){const t={};return e.forEach(a=>t[a]=!0),(0,m.of)(t)}_requestColumnsAccessRights(e,t){return this._rightsService.getCanEditColumns({schemaName:e,columnNames:t})}_isReadonlyColumn(e,t){const a=this._getColumnName(t),r=!de.DATA_SCHEMA_SYSTEM_COLUMNS.includes(t.path),o=t.attributeType===c.DataSchemaAttributeType.OwnAttribute,l=De.includes(t.dataValueType);return!(e[a]&&o&&r&&l)}_generateColumnDefinition(e,t,a){const{dataSourceName:r,dataSchema:o,itemsAttributeName:l,viewModel:s,features:u,dataGridName:C}=e,p=t.name,{primaryAttributeName:_,primaryDisplayAttributeName:S,name:ae}=o??{},ge=_&&`${r}_${_}`,Le={columnName:p,dataValueType:t.dataValueType,primaryDisplayAttributeName:S},xe={column:{...a,id:(0,c.generateGuid)()},context:s,itemsAttributeName:l,features:u,primaryAttributeName:ge,primaryDisplayAttributeName:S,columnName:p,dataGridName:C,dataGridSchemaName:ae},Oe=this._cellViewConfigCreatorFactory.create(Le)?.getViewElementConfig(xe)??(0,m.of)(null);return(0,m.from)(Oe).pipe((0,g.map)(Me=>({...a,cellView:Me})))}processDataGridColumnDefinitions(e,t){const{dataSourceName:a,dataSchema:r}=e;return this._getColumnsAccessRights(r).pipe((0,g.switchMap)(o=>{const l=t.map(s=>{const u=r.attributes.find(C=>(0,E.removeSpecialSymbols)(`${a}_${C.name}`)===s.code);return u?(0,oe.isUndefined)(s.readonly)?this._generateColumnDefinition(e,u,{...s,readonly:this._isReadonlyColumn(o,u)}):this._generateColumnDefinition(e,u,s):(0,m.of)(s)});return(0,m.forkJoin)(l)}))}getDataGridColumnDefinition(e,t,a){const{dataSchema:r,dataSourceName:o}=e;return this._getColumnsAccessRights(r).pipe((0,g.switchMap)(l=>{const s=`${o}_${t.name}`,u=(0,c.generateGuid)(),C={id:u,code:(0,E.removeSpecialSymbols)(s),caption:a||`#ResourceString(${u.split("-")[0]})#`,dataValueType:t.dataValueType,readonly:this._isReadonlyColumn(l,t)};return this._generateColumnDefinition(e,t,C)}))}}K.\u0275fac=function(e){return new(e||K)(i.\u0275\u0275inject(re),i.\u0275\u0275inject(ie.RightsService),i.\u0275\u0275inject(ie.FeatureService))},K.\u0275prov=i.\u0275\u0275defineInjectable({token:K,factory:K.\u0275fac,providedIn:"root"});var Ne=f(59929);class Q{constructor(e,t,a,r,o){this.schemaService=e,this._columnEditService=t,this._entitySchemaService=a,this._entitySchemaProvider=r,this._translateService=o}mapResourcesToLocalizableModel(e){const t=new E.LocalizableStringArray;return Object.keys(e).forEach(a=>{t.setValueLocalizableString(a,e[a])}),t}_replaceColumn(e,t,a){if(!e)return a;const r=(0,oe.findIndex)(a,o=>o.id===t);return a[r]={...e,changed:!0},a}processColumns(e,t,a,r){var o=this;return(0,d.Z)(function*(){const l=o.getDataSourceName({viewElementConfig:e,viewModel:t}),s=o.schemaService.getDataSourceConfigByName(l),u=o.schemaService.resources.strings;return a.forEach(C=>{const p=C.code.split("_").pop()||"",_=s?.attributes&&s?.attributes[p];C.aggregationConfig=_?.aggregationConfig||C.aggregationConfig;let S=u[(0,E.removeSpecialSymbols)(C.code)];if(!S){const ae=C.id.split("-")[0],ge=`${r.name}_${ae}`;S=u[ge]}S&&(C.captionResources=o.mapResourcesToLocalizableModel(S))}),{dataSourceSchemaName:s?.entitySchemaName,columns:a}})()}_processColumnOriginalCaption(e,t){const a=t.path;let r=e;return t.path?.startsWith("[")&&(r=t.referenceSchemaName),!a||!r||!t.aggregationConfig?(0,m.of)(t):this._entitySchemaProvider.getSchemaByName(r).pipe((0,g.switchMap)(o=>this._entitySchemaService.getEntitySchemaColumnsInformationByPath(o.uId,a," > ")),(0,g.map)(o=>{let l=o.columnCaptionPath;const s=t.aggregationConfig?.aggregationFunction;return s&&(l=this._getAggregationColumnOriginalCaption(l,t.dataValueType,s)),t.originalCaption=l,t}))}_getAggregationColumnOriginalCaption(e,t,a){const r=(0,Ne.getAllowedAggregationFunctionsByDataValueType)(t);r.push({func:c.AggregationFunction.Count,captionResource:"Count"});const o=r.find(s=>s.func===a)?.captionResource||"",l=this._getAggregationFunctionCaption(o);return a===c.AggregationFunction.TopOne?this._translateService.currentLang===E.DEFAULT_CULTURE_NAME?`${e} (the ${l.toLowerCase()})`:`${e} (${l.toLowerCase()})`:a===c.AggregationFunction.Count?`${e.split(" > ").slice(0,-1).join(" > ")} ${l}`:`${e} ${l}`}_getAggregationFunctionCaption(e){return this._translateService.instant("AggregationNames."+e)}getDataSourceName(e){const{viewElementConfig:t,viewModel:a}=e,r=ne(t);return a.getBoundDataSourceNameByAttributePath(r)}onColumnPreparationFinished(){}handle(e,t,a){const r=a.get(D.VIEW_ELEMENT_CONFIG),o=this.schemaService.getViewConfigInfoByName(r.name).viewConfig;return a.get(D.BINDING_CONTEXT).viewModel$.pipe((0,g.take)(1)).pipe((0,g.mergeMap)(u=>this.processColumns(o,u,t,r)),(0,g.mergeMap)(u=>{const C=(0,oe.cloneDeep)(u.columns.find(p=>p.id===e));return this._processColumnOriginalCaption(u.dataSourceSchemaName,C).pipe((0,m.tap)(()=>this.onColumnPreparationFinished()),(0,g.mergeMap)(p=>this._columnEditService.edit(p,a).pipe((0,g.map)(_=>this._replaceColumn(_,e,u.columns)))))}))}}Q.\u0275fac=function(e){return new(e||Q)(i.\u0275\u0275inject(j.SchemaService),i.\u0275\u0275inject(B.DataGridColumnEditService),i.\u0275\u0275inject(E.EntitySchemaService),i.\u0275\u0275inject(E.EntitySchemaProvider),i.\u0275\u0275inject(se.TranslateService))},Q.\u0275prov=i.\u0275\u0275defineInjectable({token:Q,factory:Q.\u0275fac});class q extends Q{constructor(e,t,a,r,o,l,s){super(e,t,a,r,o),this._schemaPartService=l,this._maskService=s}processColumns(e,t,a,r){var o=()=>super.processColumns,l=this;return(0,d.Z)(function*(){l._maskService.showBodyMask();const s=yield o().call(l,e,t,a,r),[,u]=yield l._schemaPartService.use("USER"),C=yield u.loadResources();return s?.columns.forEach(p=>{let _=C.localizableStrings[p.code];if(!_){const S=p.id.split("-")[0],ae=`${r.name}_${S}`;_=C.localizableStrings[ae]}_&&(p.captionResources=l.mapResourcesToLocalizableModel(_))}),s})()}onColumnPreparationFinished(){this._maskService.hideBodyMask()}}q.\u0275fac=function(e){return new(e||q)(i.\u0275\u0275inject(j.SchemaService),i.\u0275\u0275inject(B.DataGridColumnEditService),i.\u0275\u0275inject(E.EntitySchemaService),i.\u0275\u0275inject(E.EntitySchemaProvider),i.\u0275\u0275inject(se.TranslateService),i.\u0275\u0275inject(j.SchemaPartsService),i.\u0275\u0275inject(c.MaskService))},q.\u0275prov=i.\u0275\u0275defineInjectable({token:q,factory:q.\u0275fac});class ee{constructor(e){this._columnSelectionService=e}_canSelectColumns(e){if(e===null)return(0,m.of)(!1);const t={type:"crt.CanDiscardUnsavedDataRequest",$context:e},a=c.HandlerChainService.instance.process(t);return(0,m.from)(a)}_getDataGridCollection(e,t){const a=e.get(D.VIEW_ELEMENT_CONFIG),r=ne(a);return r?(0,m.from)(t[r]).pipe((0,g.map)(o=>o)):(0,m.of)(null)}selectColumns(e){return e.get(D.BINDING_CONTEXT).viewModel$.pipe((0,g.switchMap)(t=>this._getDataGridCollection(e,t)),(0,g.switchMap)(t=>this._canSelectColumns(t)),(0,g.switchMap)(t=>(0,m.iif)(()=>t,this._columnSelectionService.selectColumns(e),(0,m.of)([]))),(0,g.take)(1))}}ee.\u0275fac=function(e){return new(e||ee)(i.\u0275\u0275inject(B.DataGridColumnSelectionService))},ee.\u0275prov=i.\u0275\u0275defineInjectable({token:ee,factory:ee.\u0275fac});const Fe=ue.FactoryProvider.create({token:re,mappings:[{predicate:({columnName:n,primaryDisplayAttributeName:e})=>Boolean(n)&&n===e,injectable:H},{predicate:({dataValueType:n})=>n===c.DataValueType.Lookup,injectable:Z},{predicate:({dataValueType:n})=>n===c.DataValueType.Boolean,injectable:z},{predicate:({dataValueType:n})=>n===c.DataValueType.PHONE_TEXT,injectable:V},{predicate:({dataValueType:n})=>n===c.DataValueType.EMAIL_TEXT,injectable:I},{predicate:({dataValueType:n})=>n===c.DataValueType.RICH_TEXT,injectable:w},{predicate:({dataValueType:n})=>n===c.DataValueType.EMAIL_TEXT||n===c.DataValueType.WEB_TEXT,injectable:X},{predicate:({dataValueType:n,columnName:e})=>n===c.DataValueType.Guid&&e.includes("DcmStageValue"),injectable:b}]}),Re=ue.FactoryProvider.create({token:he,mappings:[{predicate:({dataValueType:n})=>E.DATE_TIME_DATA_VALUE_TYPES.includes(n),injectable:G},{predicate:({dataValueType:n})=>E.NUMERIC_DATA_VALUE_TYPES.includes(n),injectable:F},{predicate:({dataValueType:n})=>n===c.DataValueType.Lookup,injectable:R},{predicate:({dataValueType:n})=>n===c.DataValueType.Boolean,injectable:L},{predicate:({dataValueType:n})=>n===c.DataValueType.PHONE_TEXT,injectable:x},{predicate:({dataValueType:n})=>n===c.DataValueType.EMAIL_TEXT,injectable:O},{predicate:({dataValueType:n})=>n===c.DataValueType.WEB_TEXT,injectable:M},{predicate:({dataValueType:n,columnName:e})=>n===c.DataValueType.Guid&&e.includes("DcmStageValue"),injectable:$}],default:{injectable:N}}),Ge=ue.FactoryProvider.create({token:_e,mappings:[{predicate:({columnName:n,primaryDisplayAttributeName:e})=>n&&n===e,injectable:v},{predicate:({columnName:n})=>n&&n==="Size",injectable:A}]});var te=f(74742);let Ce=class extends c.BaseRequest{constructor(){super(...arguments),this.type="crt.DataGridCancelItemsChangesRequest"}};Ce=(0,te.__decorate)([(0,c.CrtRequest)({type:"crt.DataGridCancelItemsChangesRequest"})],Ce);let ce=class extends c.BaseRequestHandler{constructor(e){super(),this._schemaService=e}_canCancelItemsChanges(e){var t=this;return(0,d.Z)(function*(){const{$context:a,itemsAttributeName:r,changedItems:o}=e;if(!a||!r)return!1;if(o&&o.length>0)return!0;const l=yield a[r],s={type:"crt.CanDiscardUnsavedDataRequest",$context:l};return yield t.handlerChain.process(s)})()}_cancelItemsChanges(e){var t=this;return(0,d.Z)(function*(){const a={type:"crt.CancelRecordsChangesRequest",$context:e.$context,recordIds:e.changedItems,itemsAttributeName:e.itemsAttributeName};return yield t.handlerChain.process(a)})()}_getDataGridViewConfigs(e){return this._schemaService.getViewConfigInfoByFilter(t=>{const{type:a,items:r}=t;return a==="crt.DataGrid"&&r===`$${e}`}).map(t=>t.viewConfig)}_cleanupSelectionState(e,t){const a=this._getDataGridViewConfigs(e).map(r=>r?._selectionOptions?.attribute||(0,B.createDataGridSelectionStateAttributeName)(r)).map(r=>this.handlerChain.process({type:"crt.ChangeViewModelAttributeValueRequest",$context:t,attributeName:r,attributeValue:null}));return Promise.all(a)}handle(e){var t=this;return(0,d.Z)(function*(){return e?(yield t._canCancelItemsChanges(e))?t._cancelItemsChanges(e):(yield t._cleanupSelectionState(e.itemsAttributeName,e.$context),!1):!1})()}};ce=(0,te.__decorate)([(0,c.CrtRequestHandler)({type:"crt.DataGridCancelItemsChangesHandler",requestType:"crt.DataGridCancelItemsChangesRequest"}),(0,te.__metadata)("design:paramtypes",[j.SchemaService])],ce);let me=class extends c.BaseRequest{};me=(0,te.__decorate)([(0,c.CrtRequest)({type:"crt.DataGridRowDoubleClickRequest"})],me);let le=class extends c.BaseRequestHandler{_isClickByNewRecord(e){return(0,d.Z)(function*(){const{itemsAttributeName:t,rowId:a}=e;return!t||!a?!1:(yield(yield e.$context[t])?.findByPrimaryAttribute(a))?.getPrimaryModelMode()===E.ModelMode.Create})()}_createUpdateRecordRequest(e){return{type:"crt.UpdateRecordRequest",$context:e.$context,recordId:e.rowId,itemsAttributeName:e.itemsAttributeName}}handle(e){var t=this;return(0,d.Z)(function*(){return(yield t._isClickByNewRecord(e))?Promise.resolve():t.handlerChain.process(t._createUpdateRecordRequest(e))})()}};le=(0,te.__decorate)([(0,c.CrtRequestHandler)({requestType:"crt.DataGridRowDoubleClickRequest",type:"crt.DataGridRowDoubleClickHandler"})],le);var Te=f(31134);let T=class{};T.\u0275fac=function(e){return new(e||T)},T.\u0275mod=i.\u0275\u0275defineNgModule({type:T}),T.\u0275inj=i.\u0275\u0275defineInjector({imports:[Te.CommonModule]}),T=(0,te.__decorate)([(0,c.CrtModule)({requestHandlers:[ce,le]})],T),function(){(typeof ngJitMode>"u"||ngJitMode)&&i.\u0275\u0275setNgModuleScope(T,{imports:[Te.CommonModule]})}()}}]);
